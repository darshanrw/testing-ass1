name: Docker CI Pipeline

on:
  pull_request:
    branches:
      - feature

env:
  IMAGE_NAME: express-app
  CONTAINER_NAME: assignment1
  PORT: 8080

jobs:
  docker-workflow:
    name: Build, Run, and Stop Docker Container
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Docker
      uses: docker/setup-buildx-action@v2

    - name: Cache Docker Layers
      uses: actions/cache@v2
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Build Docker Image
      run: docker build -t $IMAGE_NAME .

    - name: Run the Docker Container
      run: |
        docker run -d --name $CONTAINER_NAME -p $PORT:$PORT $IMAGE_NAME
        echo "Docker container started successfully."

    - name: Verify the Running Container
      run: docker ps -a

    - name: Stop and Remove the Container
      run: |
        docker stop $CONTAINER_NAME || true
        docker rm $CONTAINER_NAME || true
        echo "Docker container stopped and removed."
